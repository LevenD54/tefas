<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TEFAS Fon Analiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sort-icon::after { content: '↕'; margin-left: 5px; opacity: 0.3; }
        .sort-asc::after { content: '↑'; opacity: 1; color: #2563eb; }
        .sort-desc::after { content: '↓'; opacity: 1; color: #2563eb; }
    </style>
<script type="importmap">
{
  "imports": {
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@^2.90.1"
  }
}
</script>
</head>
<body class="pb-12">

    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-teal-600 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 tracking-tight">TEFAS Analiz</h1>
                        <p class="text-xs text-gray-500">Node.js & Vanilla JS</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="fetchData()" class="p-2 text-gray-500 hover:text-teal-600 hover:bg-teal-50 rounded-full transition-all" title="Yenile">
                        <svg id="refreshIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 space-y-8">
        
        <!-- Filters -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div class="flex items-center gap-2 bg-white p-1 rounded-lg border border-gray-200 shadow-sm" id="filterContainer">
                <button onclick="filterFunds('Tümü', this)" class="filter-btn px-4 py-1.5 text-sm font-medium rounded-md bg-teal-600 text-white shadow-sm transition-all">Tümü</button>
                <button onclick="filterFunds('Hisse Senedi', this)" class="filter-btn px-4 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 transition-all">Hisse</button>
                <button onclick="filterFunds('Altın', this)" class="filter-btn px-4 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 transition-all">Altın</button>
                <button onclick="filterFunds('Borçlanma Araçları', this)" class="filter-btn px-4 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 transition-all">Borçlanma</button>
            </div>
            <div class="text-xs text-gray-400" id="lastUpdated"></div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-teal-100 border-t-teal-600 mb-6"></div>
            <h2 class="text-xl font-bold text-gray-800">Veriler Yükleniyor</h2>
            <p class="text-sm text-gray-500 mt-2">Sunucudan veriler çekiliyor...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-white p-8 rounded-2xl shadow-lg border border-red-100 max-w-lg mx-auto text-center">
            <div class="bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Hata Oluştu</h2>
            <p id="errorMessage" class="text-gray-600 mb-6 text-sm font-mono bg-gray-100 p-2 rounded overflow-auto max-h-32"></p>
            <button onclick="fetchData()" class="px-5 py-2.5 bg-teal-600 text-white font-medium rounded-lg hover:bg-teal-700">Tekrar Dene</button>
        </div>

        <!-- Content -->
        <div id="content" class="hidden space-y-8">
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <p class="text-sm font-medium text-gray-500 mb-1">Günün En İyisi</p>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2" id="statBest">--</h3>
                    <div class="flex items-center text-sm text-green-600">
                        <span class="font-semibold" id="statBestVal">--</span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <p class="text-sm font-medium text-gray-500 mb-1">Ortalama Yıllık Getiri</p>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2" id="statAvg">--</h3>
                    <div class="flex items-center text-sm text-blue-600">
                        <span class="font-normal text-gray-400">Sektör Ortalaması</span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <p class="text-sm font-medium text-gray-500 mb-1">Listelenen Fon</p>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2" id="statCount">--</h3>
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-6">Yıllık En Çok Kazandıran Top 10 Fon</h3>
                <div class="relative h-80 w-full">
                    <canvas id="fundChart"></canvas>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase cursor-pointer sticky left-0 bg-gray-50" onclick="sortTable('code')">Fon <span id="sort-code" class="sort-icon"></span></th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-gray-500 uppercase cursor-pointer" onclick="sortTable('price')">Fiyat <span id="sort-price" class="sort-icon"></span></th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-gray-500 uppercase cursor-pointer" onclick="sortTable('daily_return')">Günlük <span id="sort-daily_return" class="sort-icon sort-desc"></span></th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-gray-500 uppercase cursor-pointer hidden md:table-cell" onclick="sortTable('monthly_return')">1 Ay <span id="sort-monthly_return" class="sort-icon"></span></th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-gray-500 uppercase cursor-pointer" onclick="sortTable('yearly_return')">1 Yıl <span id="sort-yearly_return" class="sort-icon"></span></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-100 text-sm">
                            <!-- Rows inserted via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        let allFunds = [];
        let currentType = 'Tümü';
        let sortCol = 'daily_return';
        let sortAsc = false;
        let chartInstance = null;

        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            
            try {
                // Fetch from our Node.js API
                const response = await fetch('/api/funds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: "calismatipi=2&fontip=YAT&sfontip=TUM" // Initial dummy payload
                });

                const json = await response.json();
                
                if (!response.ok) throw new Error(json.error || 'Server Error');
                
                // Map the data to a cleaner structure if coming from direct DB or API
                allFunds = json.data.map(item => ({
                    code: item.FONKODU || item.code,
                    title: item.FONUNADI || item.title,
                    price: parseFloat(item.FIYAT || item.price),
                    daily_return: parseFloat(item.GUNLUKGETIRI || item.daily_return),
                    monthly_return: parseFloat(item.AYLIKGETIRI || item.monthly_return),
                    yearly_return: parseFloat(item.YILLIKGETIRI || item.yearly_return)
                }));

                document.getElementById('lastUpdated').innerText = 'Son Güncelleme: ' + new Date().toLocaleTimeString();
                
                render();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                
            } catch (err) {
                console.error(err);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('errorMessage').innerText = err.message;
            }
        }

        function filterFunds(type, btnElement) {
            currentType = type;
            // Update visual buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-teal-600', 'text-white', 'shadow-sm');
                btn.classList.add('text-gray-600', 'hover:bg-gray-50');
            });
            btnElement.classList.remove('text-gray-600', 'hover:bg-gray-50');
            btnElement.classList.add('bg-teal-600', 'text-white', 'shadow-sm');
            
            render();
        }

        function render() {
            // Filter
            let filtered = allFunds;
            if (currentType === 'Altın') filtered = allFunds.filter(f => f.title.includes('ALTIN') || f.title.includes('KIYMETLİ MADEN'));
            else if (currentType === 'Hisse Senedi') filtered = allFunds.filter(f => f.title.includes('HİSSE'));
            else if (currentType === 'Borçlanma Araçları') filtered = allFunds.filter(f => f.title.includes('BORÇLANMA') || f.title.includes('EUROBOND'));

            // Sort
            filtered.sort((a, b) => {
                let valA = a[sortCol];
                let valB = b[sortCol];
                if (typeof valA === 'string') return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                return sortAsc ? valA - valB : valB - valA;
            });

            // Update Stats
            if (filtered.length > 0) {
                const best = [...filtered].sort((a, b) => b.daily_return - a.daily_return)[0];
                const avg = filtered.reduce((a, b) => a + b.yearly_return, 0) / filtered.length;
                
                document.getElementById('statBest').innerText = best.code;
                document.getElementById('statBestVal').innerText = '%' + best.daily_return.toFixed(2);
                document.getElementById('statAvg').innerText = '%' + avg.toFixed(1);
                document.getElementById('statCount').innerText = filtered.length;
            }

            // Render Table
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filtered.map(f => `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-4 py-3 font-medium text-gray-900 sticky left-0 bg-white">
                        <div class="flex items-center">
                            <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-xs font-bold mr-3">${f.code}</span>
                            <div class="truncate max-w-[120px] md:max-w-xs" title="${f.title}">${f.title}</div>
                        </div>
                    </td>
                    <td class="px-3 py-3 text-right font-mono">${f.price.toFixed(4)}</td>
                    <td class="px-3 py-3 text-right font-bold ${f.daily_return >= 0 ? 'text-teal-600' : 'text-red-500'}">%${f.daily_return.toFixed(2)}</td>
                    <td class="px-3 py-3 text-right hidden md:table-cell ${f.monthly_return >= 0 ? 'text-teal-600' : 'text-red-500'}">%${f.monthly_return.toFixed(2)}</td>
                    <td class="px-3 py-3 text-right font-bold ${f.yearly_return >= 0 ? 'text-teal-600' : 'text-red-500'}">%${f.yearly_return.toFixed(2)}</td>
                </tr>
            `).join('');

            // Update Sort Icons
            document.querySelectorAll('.sort-icon').forEach(el => el.className = 'sort-icon');
            const currentHeader = document.getElementById('sort-' + sortCol);
            if (currentHeader) currentHeader.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');

            // Render Chart
            renderChart(filtered);
        }

        function sortTable(col) {
            if (sortCol === col) sortAsc = !sortAsc;
            else {
                sortCol = col;
                sortAsc = false; // Default desc for numbers usually better
            }
            render();
        }

        function renderChart(data) {
            const ctx = document.getElementById('fundChart');
            
            // Top 10 by yearly return
            const top10 = [...data].sort((a, b) => b.yearlyReturn - a.yearlyReturn).slice(0, 10);
            
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.code),
                    datasets: [{
                        label: 'Yıllık Getiri (%)',
                        data: top10.map(d => d.yearly_return),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Init
        fetchData();
    </script>
</body>
</html>